!function(a,b,c,d){"use strict";function e(a){return String.fromCharCode(a.charCodeAt(0)-32)+a.slice(1)}function f(a,b,c){var d=b-(a+"").length;d=0>d?0:d;for(var e="",f=0;d>f;f++)e+=c;return e+a}function g(a,b){for(var d=0;d<b.length;d++){var e=b[d];if(c.isUndefined(a[e]))throw new TypeError("'"+e+"' is required")}}function h(a,b){if(c.isString(a)){var d=e(a)+b,f=j[d]||j.Extension[d];if(c.isUndefined(f))throw new ReferenceError("Class '"+d+"' not found");return f}return a}var i=a,j=a.Backgrid={VERSION:"0.1.4",Extension:{}},k="	\n\f\r   ᠎             　\u2028\u2029﻿";if(!String.prototype.trim||k.trim()){k="["+k+"]";var l=new RegExp("^"+k+k+"*"),m=new RegExp(k+k+"*$");String.prototype.trim=function(){if(void 0===this||null===this)throw new TypeError("can't convert "+this+" to object");return String(this).replace(l,"").replace(m,"")}}var n=j.CellFormatter=function(){};c.extend(n.prototype,{fromRaw:function(a){return a},toRaw:function(a){return a}});var o=j.NumberFormatter=function(a){if(a=a?c.clone(a):{},c.extend(this,this.defaults,a),this.decimals<0||this.decimals>20)throw new RangeError("decimals must be between 0 and 20")};o.prototype=new n,c.extend(o.prototype,{defaults:{decimals:2,decimalSeparator:".",orderSeparator:","},HUMANIZED_NUM_RE:/(\d)(?=(?:\d{3})+$)/g,fromRaw:function(a){if(isNaN(a)||null===a)return"";a=a.toFixed(~~this.decimals);var b=a.split("."),c=b[0],d=b[1]?(this.decimalSeparator||".")+b[1]:"";return c.replace(this.HUMANIZED_NUM_RE,"$1"+this.orderSeparator)+d},toRaw:function(a){for(var b="",d=a.trim().split(this.orderSeparator),e=0;e<d.length;e++)b+=d[e];var f=b.split(this.decimalSeparator);b="";for(var e=0;e<f.length;e++)b=b+f[e]+".";"."===b[b.length-1]&&(b=b.slice(0,b.length-1));var g=1*(1*b).toFixed(~~this.decimals);return c.isNumber(g)&&!c.isNaN(g)?g:void 0}});var p=j.DatetimeFormatter=function(a){if(a=a?c.clone(a):{},c.extend(this,this.defaults,a),!this.includeDate&&!this.includeTime)throw new Error("Either includeDate or includeTime must be true")};p.prototype=new n,c.extend(p.prototype,{defaults:{includeDate:!0,includeTime:!0,includeMilli:!1},DATE_RE:/^([+\-]?\d{4})-(\d{2})-(\d{2})$/,TIME_RE:/^(\d{2}):(\d{2}):(\d{2})(\.(\d{3}))?$/,ISO_SPLITTER_RE:/T|Z| +/,_convert:function(a,b){if(c.isNull(a)||c.isUndefined(a))return a;a=a.trim();var d=a.split(this.ISO_SPLITTER_RE)||[],e=this.DATE_RE.test(d[0])?d[0]:"",g=e&&d[1]?d[1]:this.TIME_RE.test(d[0])?d[0]:"",h=this.DATE_RE.exec(e)||[],i=this.TIME_RE.exec(g)||[];if(b){if(this.includeDate&&c.isUndefined(h[0]))return;if(this.includeTime&&c.isUndefined(i[0]))return;if(!this.includeDate&&e)return;if(!this.includeTime&&g)return}var j=new Date(Date.UTC(1*h[1]||0,1*h[2]-1||0,1*h[3]||0,1*i[1]||null,1*i[2]||null,1*i[3]||null,1*i[5]||null)),k="";return this.includeDate&&(k=f(j.getUTCFullYear(),4,0)+"-"+f(j.getUTCMonth()+1,2,0)+"-"+f(j.getUTCDate(),2,0)),this.includeTime&&(k=k+(this.includeDate?"T":"")+f(j.getUTCHours(),2,0)+":"+f(j.getUTCMinutes(),2,0)+":"+f(j.getUTCSeconds(),2,0),this.includeMilli&&(k=k+"."+f(j.getUTCMilliseconds(),3,0))),this.includeDate&&this.includeTime&&(k+="Z"),k},fromRaw:function(a){return this._convert(a)},toRaw:function(a){return this._convert(a,!0)}});{var q=j.CellEditor=d.View.extend({initialize:function(a){g(a,["formatter","column","model"]),this.parent=a.parent,this.formatter=a.formatter,this.column=a.column,this.column instanceof w||(this.column=new w(this.column)),this.parent&&c.isFunction(this.parent.on)&&this.listenTo(this.parent,"editing",this.postRender)},postRender:function(){return this.$el.focus(),this}}),r=j.InputCellEditor=q.extend({tagName:"input",attributes:{type:"text"},events:{blur:"saveOrCancel",keydown:"saveOrCancel"},initialize:function(a){q.prototype.initialize.apply(this,arguments),a.placeholder&&this.$el.attr("placeholder",a.placeholder),this.listenTo(this,"done",this.remove)},render:function(){return this.$el.val(this.formatter.fromRaw(this.model.get(this.column.get("name")))),this},saveOrCancel:function(a){if("keydown"===a.type)if(13===a.keyCode||9===a.keyCode){a.preventDefault();var b=this.formatter.toRaw(this.$el.val());this.trigger(c.isUndefined(b)||!this.model.set(this.column.get("name"),b,{validate:!0})?"error":"done")}else 27===a.keyCode&&(a.stopPropagation(),this.trigger("done"));else if("blur"===a.type)if(this.formatter.fromRaw(this.model.get(this.column.get("name")))===this.$el.val())this.trigger("done");else var d=this,e=i.setTimeout(function(){d.$el.focus(),i.clearTimeout(e)},1)},postRender:function(){if("right"===this.$el.css("text-align")){var a=this.$el.val();this.$el.focus().val(null).val(a)}else this.$el.focus();return this}}),s=j.Cell=d.View.extend({tagName:"td",formatter:new n,editor:r,events:{click:"enterEditMode"},initialize:function(a){g(a,["model","column"]),this.column=a.column,this.column instanceof w||(this.column=new w(this.column)),this.formatter=h(this.formatter,"Formatter"),this.editor=h(this.editor,"CellEditor"),this.listenTo(this.model,"change:"+this.column.get("name"),function(){this.$el.hasClass("editor")||this.render()})},render:function(){return this.$el.empty().text(this.formatter.fromRaw(this.model.get(this.column.get("name")))),this},enterEditMode:function(){this.column.get("editable")&&(this.currentEditor=new this.editor({parent:this,column:this.column,model:this.model,formatter:this.formatter}),this.trigger("edit",this,this.currentEditor),this.listenTo(this.currentEditor,"done",this.exitEditMode),this.listenTo(this.currentEditor,"error",this.renderError),this.$el.empty(),this.undelegateEvents(),this.$el.append(this.currentEditor.$el),this.currentEditor.render(),this.$el.addClass("editor"),this.trigger("editing",this,this.currentEditor))},renderError:function(){this.$el.addClass("error")},exitEditMode:function(){this.$el.removeClass("error"),this.currentEditor.off(null,null,this),this.currentEditor.remove(),delete this.currentEditor,this.$el.removeClass("editor"),this.render(),this.delegateEvents()},remove:function(){return this.currentEditor&&(this.currentEditor.remove.apply(this,arguments),delete this.currentEditor),d.View.prototype.remove.apply(this,arguments)}}),t=(j.StringCell=s.extend({className:"string-cell"}),j.UriCell=s.extend({className:"uri-cell",formatter:{fromRaw:function(a){return a},toRaw:function(a){var b=encodeURI(a);return"undefined"===b?void 0:b}},render:function(){this.$el.empty();var a=this.formatter.fromRaw(this.model.get(this.column.get("name")));return this.$el.append(b("<a>",{href:a,title:a,target:"_blank"}).text(a)),this}}),j.EmailCell=s.extend({className:"email-cell",formatter:{fromRaw:function(a){return a},toRaw:function(a){var b=a.split("@");return 2===b.length&&c.all(b)?a:void 0}},render:function(){this.$el.empty();var a=this.formatter.fromRaw(this.model.get(this.column.get("name")));return this.$el.append(b("<a>",{href:"mailto:"+a,title:a}).text(a)),this}}),j.NumberCell=s.extend({className:"number-cell",decimals:o.prototype.defaults.decimals,decimalSeparator:o.prototype.defaults.decimalSeparator,orderSeparator:o.prototype.defaults.orderSeparator,formatter:o,initialize:function(){s.prototype.initialize.apply(this,arguments),this.formatter=new this.formatter({decimals:this.decimals,decimalSeparator:this.decimalSeparator,orderSeparator:this.orderSeparator})}})),u=(j.IntegerCell=t.extend({className:"integer-cell",decimals:0}),j.DatetimeCell=s.extend({className:"datetime-cell",includeDate:p.prototype.defaults.includeDate,includeTime:p.prototype.defaults.includeTime,includeMilli:p.prototype.defaults.includeMilli,formatter:p,initialize:function(){s.prototype.initialize.apply(this,arguments),this.formatter=new this.formatter({includeDate:this.includeDate,includeTime:this.includeTime,includeMilli:this.includeMilli});var a=this.includeDate?"YYYY-MM-DD":"";a+=this.includeDate&&this.includeTime?"T":"",a+=this.includeTime?"HH:mm:ss":"",a+=this.includeTime&&this.includeMilli?".SSS":"",this.editor=this.editor.extend({attributes:c.extend({},this.editor.prototype.attributes,this.editor.attributes,{placeholder:a})})}})),v=(j.DateCell=u.extend({className:"date-cell",includeTime:!1}),j.TimeCell=u.extend({className:"time-cell",includeDate:!1}),j.BooleanCell=s.extend({className:"boolean-cell",editor:c.template("<input type='checkbox'<%= checked ? checked='checked' : '' %> />'"),events:{click:"enterEditMode","blur input[type=checkbox]":"exitEditMode","change input[type=checkbox]":"save"},render:function(){return this.$el.empty(),this.currentEditor=b(this.editor({checked:this.formatter.fromRaw(this.model.get(this.column.get("name")))})),this.$el.append(this.currentEditor),this},enterEditMode:function(){this.$el.addClass("editor"),this.currentEditor.focus()},exitEditMode:function(){this.$el.removeClass("editor")},save:function(){var a=this.formatter.toRaw(this.currentEditor.prop("checked"));this.model.set(this.column.get("name"),a)}}),j.SelectCellEditor=q.extend({tagName:"select",events:{change:"save",blur:"save"},template:c.template('<option value="<%- value %>" <%= selected ? \'selected="selected"\' : "" %>><%- text %></option>'),setOptionValues:function(a){this.optionValues=a},_renderOptions:function(a,b){for(var c="",d=0;d<a.length;d++)c+=this.template({text:a[d][0],value:a[d][1],selected:b==a[d][1]});return c},render:function(){this.$el.empty();var a=c.result(this,"optionValues"),d=this.model.get(this.column.get("name"));if(!c.isArray(a))throw TypeError("optionValues must be an array");for(var e=null,f=null,e=null,g=null,h=null,i=0;i<a.length;i++){var e=a[i];if(c.isArray(e))f=e[0],e=e[1],this.$el.append(this.template({text:f,value:e,selected:e==d}));else{if(!c.isObject(e))throw TypeError("optionValues elements must be a name-value pair or an object hash of { name: 'optgroup label', value: [option name-value pairs] }");g=e.name,h=b("<optgroup></optgroup>",{label:g}),h.append(this._renderOptions(e.values,d)),this.$el.append(h)}}return this},save:function(){this.model.set(this.column.get("name"),this.formatter.toRaw(this.$el.val())),this.trigger("done")}})),w=(j.SelectCell=s.extend({className:"select-cell",editor:v,optionValues:void 0,initialize:function(){s.prototype.initialize.apply(this,arguments),g(this,["optionValues"]),this.optionValues=c.result(this,"optionValues"),this.listenTo(this,"edit",this.setOptionValues)},setOptionValues:function(a,b){b.setOptionValues(this.optionValues)},render:function(){this.$el.empty();var a=this.optionValues,b=this.formatter.fromRaw(this.model.get(this.column.get("name")));try{if(!c.isArray(a)||c.isEmpty(a))throw new TypeError;for(var d=0;d<a.length;d++){var e=a[d];if(c.isArray(e)){var f=e[0],e=e[1];if(e==b){this.$el.append(f);break}}else{if(!c.isObject(e))throw new TypeError;for(var g=e.values,h=0;h<g.length;h++){var i=g[h];if(i[1]==b){this.$el.append(i[0]);break}}}}}catch(j){if(j instanceof TypeError)throw TypeError("'optionValues' must be of type {Array.<Array>|Array.<{name: string, values: Array.<Array>}>}");throw j}return this}}),j.Column=d.Model.extend({defaults:{name:void 0,label:void 0,sortable:!0,editable:!0,renderable:!0,formatter:void 0,cell:void 0,headerCell:void 0},initialize:function(a){g(a,["cell","name"]),this.has("label")||this.set({label:this.get("name")},{silent:!0});var b=h(this.get("cell"),"Cell");this.set({cell:b},{silent:!0})}})),x=j.Columns=d.Collection.extend({model:w}),y=j.Row=d.View.extend({tagName:"tr",initOptionRequires:["columns","model"],initialize:function(a){g(a,this.initOptionRequires);var b=this.columns=a.columns;b instanceof d.Collection||(b=this.columns=new x(b));for(var c=this.cells=[],e=0;e<b.length;e++)c.push(this.makeCell(b.at(e),a));this.listenTo(b,"change:renderable",function(a,b){for(var d=0;d<c.length;d++){var e=c[d];e.column.get("name")==a.get("name")&&(b?e.$el.show():e.$el.hide())}}),this.listenTo(b,"add",function(b,d){var e=d.indexOf(b),f=this.makeCell(b,a);c.splice(e,0,f),f.column.get("renderable")||f.$el.hide();var g=this.$el;0===e?g.prepend(f.render().$el):e===d.length-1?g.append(f.render().$el):g.children().eq(e).before(f.render().$el)}),this.listenTo(b,"remove",function(a,b,d){c[d.index].remove(),c.splice(d.index,1)})},makeCell:function(a){return new(a.get("cell"))({column:a,model:this.model})},render:function(){this.$el.empty();for(var a=document.createDocumentFragment(),b=0;b<this.cells.length;b++){var c=this.cells[b];a.appendChild(c.render().el),c.column.get("renderable")||c.$el.hide()}return this.el.appendChild(a),this},remove:function(){for(var a=0;a<this.cells.length;a++){var b=this.cells[a];b.remove.apply(b,arguments)}return d.View.prototype.remove.apply(this,arguments)}}),z=j.HeaderCell=d.View.extend({tagName:"th",events:{"click a":"onClick"},_direction:null,initialize:function(a){g(a,["column","collection"]),this.column=a.column,this.column instanceof w||(this.column=new w(this.column)),this.listenTo(d,"backgrid:sort",this._resetCellDirection)},direction:function(a){return arguments.length&&(this._direction&&this.$el.removeClass(this._direction),a&&this.$el.addClass(a),this._direction=a),this._direction},_resetCellDirection:function(a,b,c,d){d==this.collection&&this.direction(a!==this.column.get("name")?null:b)},onClick:function(a){a.preventDefault();var b=this.column.get("name");this.column.get("sortable")&&("ascending"===this.direction()?this.sort(b,"descending",function(a,c){var d=a.get(b),e=c.get(b);return d===e?0:d>e?-1:1}):"descending"===this.direction()?this.sort(b,null):this.sort(b,"ascending",function(a,c){var d=a.get(b),e=c.get(b);return d===e?0:e>d?-1:1}))},sort:function(a,b,c){c=c||this._cidComparator;var e=this.collection;if(d.PageableCollection&&e instanceof d.PageableCollection){var f;f="ascending"===b?-1:"descending"===b?1:null,e.setSorting(f?a:null,f),"client"==e.mode?(e.fullCollection.comparator||(e.fullCollection.comparator=c),e.fullCollection.sort()):e.fetch()}else e.comparator=c,e.sort();d.trigger("backgrid:sort",a,b,c,this.collection)},_cidComparator:function(a,b){var d=a.cid,e=b.cid;if(!c.isUndefined(d)&&!c.isUndefined(e)){if(d=1*d.slice(1),e=1*e.slice(1),e>d)return-1;if(d>e)return 1}return 0},render:function(){this.$el.empty();var a=b("<a>").text(this.column.get("label")).append("<b class='sort-caret'></b>");return this.$el.append(a),this}}),A=(j.HeaderRow=j.Row.extend({initOptionRequires:["columns","collection"],initialize:function(){j.Row.prototype.initialize.apply(this,arguments)},makeCell:function(a,b){var c=a.get("headerCell")||b.headerCell||z;return c=new c({column:a,collection:this.collection})}}),j.Header=d.View.extend({tagName:"thead",initialize:function(a){g(a,["columns","collection"]),this.columns=a.columns,this.columns instanceof d.Collection||(this.columns=new x(this.columns)),this.row=new j.HeaderRow({columns:this.columns,collection:this.collection})},render:function(){return this.$el.append(this.row.render().$el),this},remove:function(){return this.row.remove.apply(this.row,arguments),d.View.prototype.remove.apply(this,arguments)}})),B=j.Body=d.View.extend({tagName:"tbody",initialize:function(a){g(a,["columns","collection"]),this.columns=a.columns,this.columns instanceof d.Collection||(this.columns=new x(this.columns)),this.row=a.row||y,this.rows=this.collection.map(function(a){var b=new this.row({columns:this.columns,model:a});return b},this);var b=this.collection;this.listenTo(b,"add",this.insertRow),this.listenTo(b,"remove",this.removeRow),this.listenTo(b,"sort",this.refresh),this.listenTo(b,"reset",this.refresh)},insertRow:function(a,b,e){if(!(b instanceof d.Collection||e))return void this.collection.add(a,e=b);e=c.extend({render:!0},e||{});var f=new this.row({columns:this.columns,model:a}),g=b.indexOf(a);this.rows.splice(g,0,f);var h=this.$el,i=h.children(),j=f.render().$el;e.render&&(g>=i.length?h.append(j):i.eq(g).before(j))},removeRow:function(a,b,d){return d?((c.isUndefined(d.render)||d.render)&&this.rows[d.index].remove(),void this.rows.splice(d.index,1)):void this.collection.remove(a,d=b)},refresh:function(){var a=this;return c.each(a.rows,function(a){a.remove()}),a.rows=a.collection.map(function(b){var c=new a.row({columns:a.columns,model:b});return c}),a.render(),d.trigger("backgrid:refresh"),a},render:function(){this.$el.empty();for(var a=document.createDocumentFragment(),b=0;b<this.rows.length;b++){var c=this.rows[b];a.appendChild(c.render().el)}return this.el.appendChild(a),this},remove:function(){for(var a=0;a<this.rows.length;a++){var b=this.rows[a];b.remove.apply(b,arguments)}return d.View.prototype.remove.apply(this,arguments)}});j.Footer=d.View.extend({tagName:"tfoot",initialize:function(a){g(a,["columns","collection"]),this.parent=a.parent,this.columns=a.columns,this.columns instanceof d.Collection||(this.columns=new j.Columns(this.columns))}}),j.Grid=d.View.extend({tagName:"table",className:"backgrid",header:A,body:B,footer:null,initialize:function(a){g(a,["columns","collection"]),a.columns instanceof d.Collection||(a.columns=new x(a.columns)),this.columns=a.columns,this.header=a.header||this.header,this.header=new this.header(a),this.body=a.body||this.body,this.body=new this.body(a),this.footer=a.footer||this.footer,this.footer&&(this.footer=new this.footer(a)),this.listenTo(this.columns,"reset",function(){this.header=new(this.header.remove().constructor)(a),this.body=new(this.body.remove().constructor)(a),this.footer&&(this.footer=new(this.footer.remove().constructor)(a)),this.render()})},insertRow:function(a,b,c){return this.body.insertRow(a,b,c)},removeRow:function(a,b,c){return this.body.removeRow(a,b,c)},insertColumn:function(a,b){return b=b||{render:!0},this.columns.add(a,b),this},removeColumn:function(a,b){return this.columns.remove(a,b),this},render:function(){return this.$el.empty(),this.$el.append(this.header.render().$el),this.footer&&this.$el.append(this.footer.render().$el),this.$el.append(this.body.render().$el),this.trigger("rendered"),this},remove:function(){return this.header.remove.apply(this.header,arguments),this.body.remove.apply(this.body,arguments),this.footer&&this.footer.remove.apply(this.footer,arguments),d.View.prototype.remove.apply(this,arguments)}})}}(this,$,_,Backbone);