!function(a){if("object"==typeof exports)module.exports=a(require("underscore"),require("backbone"));else if("function"==typeof define&&define.amd)define(["underscore","backbone"],a);else if("undefined"!=typeof _&&"undefined"!=typeof Backbone){var b=Backbone.PageableCollection,c=Backbone.PageableCollection=a(_,Backbone);Backbone.PageableCollection.noConflict=function(){return Backbone.PageableCollection=b,c}}}(function(a,b){"use strict";function c(b,c){if(b*=1,!a.isNumber(b)||a.isNaN(b)||!a.isFinite(b)||~~b!==b)throw new TypeError("`"+c+"` must be a finite integer");return b}function d(a){for(var b,c,d,e,f={},g=decodeURIComponent,h=a.split("&"),i=0,j=h.length;j>i;i++){var k=h[i];b=k.split("="),c=b[0],d=b[1]||!0,c=g(c),e=f[c],o(e)?e.push(d):f[c]=e?[e,d]:d}return f}function e(){var b=arguments[0],c=a.toArray(arguments).slice(1),d=b.comparator;b.comparator=null;try{b.reset.apply(b,c)}finally{b.comparator=d,d&&b.sort()}return b}var f=a.extend,g=a.omit,h=a.clone,i=a.each,j=a.pick,k=a.contains,l=a.isEmpty,m=a.pairs,n=a.invert,o=a.isArray,p=a.isFunction,q=a.keys,r=a.isUndefined,s=Math.ceil,t=b.Collection.prototype,u=/[\s'"]/g,v=/[<>\s'"]/g,w=b.Collection.extend({state:{firstPage:1,lastPage:null,currentPage:null,pageSize:25,totalPages:null,totalRecords:null,sortKey:null,order:-1},mode:"server",queryParams:{currentPage:"page",pageSize:"per_page",totalPages:"total_pages",totalRecords:"total_entries",sortKey:"sort_by",order:"order",directions:{"-1":"asc",1:"desc"}},initialize:function(a,b){b=b||{};var c=this.mode=b.mode||this.mode||x.mode,d=f({},x.queryParams,this.queryParams,b.queryParams||{});d.directions=f({},x.queryParams.directions,this.queryParams.directions,d.directions||{}),this.queryParams=d;var e=this.state=f({},x.state,this.state,b.state||{});e.currentPage=null==e.currentPage?e.firstPage:e.currentPage,"server"==c||null!=e.totalRecords||l(a)||(e.totalRecords=a.length),this.switchMode(c,f({fetch:!1,resetState:!1,models:a},b));var g=b.comparator;if(e.sortKey&&!g&&this.setSorting(e.sortKey,e.order,b),"server"!=c){if(g&&b.full){delete this.comparator;var i=this.fullCollection;i.comparator=g,i.sort()}a&&!l(a)&&(this.getPage(e.currentPage),a.splice.apply(a,[0,a.length].concat(this.models)))}this._initState=h(this.state)},_makeFullCollection:function(a,c){var d,e,f,g=["url","model","sync","comparator"],h=this.constructor.prototype,i={};for(d=0,e=g.length;e>d;d++)f=g[d],r(h[f])||(i[f]=h[f]);var j=new(b.Collection.extend(i))(a,c);for(d=0,e=g.length;e>d;d++)f=g[d],this[f]!==h[f]&&(j[f]=f);return j},_makeCollectionEventHandler:function(a,b){return function(c,d,g,j){var k=a._handlers;i(q(k),function(c){var d=k[c];a.off(c,d),b.off(c,d)});var l=h(a.state),m=l.firstPage,n=0===m?l.currentPage:l.currentPage-1,o=l.pageSize,p=n*o,t=p+o;if("add"==c){var u,v,w,x,j=j||{};if(g==b)v=b.indexOf(d),v>=p&&t>v&&(x=a,u=w=v-p);else{u=a.indexOf(d),v=p+u,x=b;var w=r(j.at)?v:j.at+p}if(++l.totalRecords,a.state=a._checkState(l),x){x.add(d,f({},j||{},{at:w}));var y=u>=o?d:!r(j.at)&&t>w&&a.length>o?a.at(o):null;if(y){var z=g._events.add,A={onAdd:!0};if(z.length){var B=z[z.length-1],C=B.callback;B.callback=function(){try{C.apply(this,arguments),a.remove(y,A)}finally{B.callback=C}}}else a.remove(y,A)}}}if("remove"==c)if(j.onAdd)delete j.onAdd;else{if(--l.totalRecords){var D=l.totalPages=s(l.totalRecords/o);l.lastPage=0===m?D-1:D,l.currentPage>D&&(l.currentPage=l.lastPage)}else l.totalRecords=null,l.totalPages=null;a.state=a._checkState(l);var E,F=j.index;g==a?((E=b.at(t))&&a.push(E),b.remove(d)):F>=p&&t>F&&(a.remove(d),E=b.at(n*(o+F)),E&&a.push(E))}if("reset"==c||"sort"==c){if(j=g,g=d,g==a&&"reset"==c){var G=b.models.slice(0,p),H=b.models.slice(p+a.models.length);j=f(j,{silent:!0}),e(b,G.concat(a.models).concat(H),j)}("reset"==c||g==b)&&((l.totalRecords=b.models.length)||(l.totalRecords=null,l.totalPages=null,l.lastPage=l.currentPage=l.firstPage),a.state=a._checkState(l),g==a&&b.trigger(c,b,j),e(a,b.models.slice(p,t),j))}i(q(k),function(c){var d=k[c];i([a,b],function(a){a.on(c,d);var b=a._events[c];b.unshift(b.pop())})})}},_checkState:function(a){var b=this.mode,d=this.links,e=a.totalRecords,f=a.pageSize,g=a.currentPage,h=a.firstPage,i=a.totalPages;if(null!=e&&null!=f&&null!=g&&null!=h&&("infinite"==b?d:!0)){if(e=c(e,"totalRecords"),f=c(f,"pageSize"),g=c(g,"currentPage"),h=c(h,"firstPage"),1>f)throw new RangeError("`pageSize` must be >= 1");if(i=a.totalPages=s(e/f),0>h||h>1)throw new RangeError("`firstPage must be 0 or 1`");if(a.lastPage=0===h?i-1:i,"infinite"==b){if(!d[g+""])throw new RangeError("No link found for page "+g)}else{if(0===h&&(h>g||g>=i))throw new RangeError("`currentPage` must be firstPage <= currentPage < totalPages if 0-based. Got "+g+".");if(1===h&&(h>g||g>i))throw new RangeError("`currentPage` must be firstPage <= currentPage <= totalPages if 1-based. Got "+g+".")}}return a},setPageSize:function(a,b){return a=c(a,"pageSize"),b=b||{},this.state=this._checkState(f({},this.state,{pageSize:a,totalPages:s(this.state.totalRecords/a)})),this.getPage(this.state.currentPage,b)},switchMode:function(b,c){if(!k(["server","client","infinite"],b))throw new TypeError('`mode` must be one of "server", "client" or "infinite"');c=c||{fetch:!0,resetState:!0};var d=this.state=c.resetState?h(this._initState):this._checkState(f({},this.state));this.mode=b;var e,j=this,l=this.fullCollection,m=this._handlers=this._handlers||{};if("server"==b||l)"server"==b&&l&&(i(q(m),function(a){e=m[a],j.off(a,e),l.off(a,e)}),delete this._handlers,this._fullComparator=l.comparator,delete this.fullCollection);else{l=this._makeFullCollection(c.models||[]),l.pageableCollection=this,this.fullCollection=l;var n=this._makeCollectionEventHandler(this,l);i(["add","remove","reset","sort"],function(b){m[b]=e=a.bind(n,{},b),j.on(b,e),l.on(b,e)}),l.comparator=this._fullComparator}if("infinite"==b)for(var o=this.links={},p=d.firstPage,r=s(d.totalRecords/d.pageSize),t=0===p?r-1:r||p,u=d.firstPage;t>=u;u++)o[u]=this.url;else this.links&&delete this.links;return c.fetch?this.fetch(g(c,"fetch","resetState")):this},hasPrevious:function(){var a=this.state,b=a.currentPage;return"infinite"!=this.mode?b>a.firstPage:!!this.links[b-1]},hasNext:function(){var a=this.state,b=this.state.currentPage;return"infinite"!=this.mode?b<a.lastPage:!!this.links[b+1]},getFirstPage:function(a){return this.getPage("first",a)},getPreviousPage:function(a){return this.getPage("prev",a)},getNextPage:function(a){return this.getPage("next",a)},getLastPage:function(a){return this.getPage("last",a)},getPage:function(a,b){var d=this.mode,h=this.fullCollection;b=b||{fetch:!1};var i=this.state,j=i.firstPage,k=i.currentPage,m=i.lastPage,n=i.pageSize,o=a;switch(a){case"first":o=j;break;case"prev":o=k-1;break;case"next":o=k+1;break;case"last":o=m;break;default:o=c(a,"index")}this.state=this._checkState(f({},i,{currentPage:o}));var p=(0===j?o:o-1)*n,q=h&&h.length?h.models.slice(p,p+n):[];return"client"!=d&&("infinite"!=d||l(q))||b.fetch?("infinite"==d&&(b.url=this.links[o]),this.fetch(g(b,"fetch"))):e(this,q,g(b,"fetch"))},sync:function(a,c,d){var e=this;if("infinite"==e.mode){var g=d.success,h=e.state.currentPage;d.success=function(a,b,c){var i=e.links,j=e.parseLinks(a,f({xhr:c},d));j.first&&(i[e.state.firstPage]=j.first),j.prev&&(i[h-1]=j.prev),j.next&&(i[h+1]=j.next),g&&g(a,b,c)}}return(t.sync||b.sync).call(e,a,c,d)},parseLinks:function(a,b){var c=b.xhr.getResponseHeader("Link"),e=["first","prev","previous","next","last"],f={};i(c.split(","),function(a){var b=a.split(";"),c=b[0].replace(v,""),d=b.slice(1);i(d,function(a){var b=a.split("="),d=b[0].replace(u,""),g=b[1].replace(u,"");"rel"==d&&k(e,g)&&("previous"==g?f.prev=c:f[g]=c)})});var g,j,l=f.last||"";if(j=(g=l.indexOf("?"))?l.slice(g+1):""){var m=d(j),n=h(this.state),o=this.queryParams,p=n.pageSize,q=1*m[o.totalRecords],r=1*m[o.currentPage],s=m[o.totalPages];q||(r?q=(0===n.firstPage?r+1:r)*p:s&&(q=s*p)),q&&(n.totalRecords=q),this.state=this._checkState(n)}return delete f.last,f},parse:function(b){if(!o(b))return new TypeError("The server response must be an array");if(2===b.length&&a.isObject(b[0])&&o(b[1])){var c=this.queryParams,d=h(this.state),e=b[0];return i(m(g(c,"directions")),function(a){var b=a[0],c=a[1];d[b]=e[c]}),e.order&&(d.order=1*n(c.directions)[e.order]),this.state=this._checkState(d),b[1]}return b},fetch:function(b){b=b||{};var c=this._checkState(this.state),i=this.mode;"infinite"!=i||b.url||(b.url=this.links[c.currentPage]);var k=b.data||{},l=b.url||a.result(this,"url")||"",n=l.indexOf("?");-1!=n&&(f(k,d(l.slice(n+1))),l=l.slice(0,n)),b.url=l,b.data=k;var o,s,u,v,w="client"==this.mode?j(this.queryParams,"sortKey","order"):g(j(this.queryParams,q(x.queryParams)),"directions"),y=m(w),z=h(this);for(o=0;o<y.length;o++)s=y[o],u=s[0],v=s[1],v=p(v)?v.call(z):v,null!=c[u]&&null!=v&&(k[v]=c[u]);c.sortKey&&c.order?k[w.order]=this.queryParams.directions[c.order+""]:c.sortKey||delete k[w.order];var A=m(g(this.queryParams,q(x.queryParams)));for(o=0;o<A.length;o++)s=A[o],v=s[1],v=p(v)?v.call(z):v,k[s[0]]=v;var B=this.fullCollection,C=this.links;if("server"!=i){var D=this,E=b.success;return b.success=function(a,d,g){g=g||{},r(b.silent)?delete g.silent:g.silent=b.silent;var h=a.models,j=c.currentPage;if("client"==i)e(B,h,g);else if(C[j]){var k=c.pageSize,l=(0===c.firstPage?j:j-1)*k,m=B.models,n=m.slice(0,l),o=m.slice(l+k);m=n.concat(h).concat(o),B.update(m,f({silent:!0,sort:!1},g)),B.comparator&&B.sort(),B.trigger("reset",B,g)}else B.add(h,f({at:B.length,silent:!0},g)),B.trigger("reset",B,g);E&&E(a,d,g)},t.fetch.call(D,f({},b,{silent:!0}))}return t.fetch.call(this,b)},_makeComparator:function(a,b){var c=this.state;return a=a||c.sortKey,b=b||c.order,a&&b?function(c,d){var e,f=c.get(a),g=d.get(a);return 1===b&&(e=f,f=g,g=e),f===g?0:g>f?-1:1}:void 0},setSorting:function(a,b,c){var d=this.state;d.sortKey=a,d.order=b=b||d.order;var e=this.fullCollection,g=!1,h=!1;a||(g=h=!0);var i=this.mode;c=f({side:"client"==i?i:"server",full:!0},c);var j=this._makeComparator(a,b),k=c.full,l=c.side;return"client"==l?k?(e&&(e.comparator=j),g=!0):(this.comparator=j,h=!0):"server"!=l||k||(this.comparator=j),g&&delete this.comparator,h&&e&&delete e.comparator,this}}),x=w.prototype;return w});