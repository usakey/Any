$(function(){$("input").iCheck({checkboxClass:"icheckbox_square-grey",radioClass:"iradio_square-grey"})});var dummyBodies=["<p>Why painful the sixteen how minuter looking nor. Subject but why ten earnest husband imagine sixteen brandon. Are unpleasing occasional celebrated motionless unaffected conviction out. Evil make to no five they. Stuff at avoid of sense small fully it whose an. Ten scarcely distance moreover handsome age although. As when have find fine or said no mile. He in dispatched in imprudence dissimilar be possession unreserved insensible. She evil face fine calm have now. Separate screened he outweigh of distance landlord.</p>","somm text bodt. Reall small. ust few lines","<p>Lose john poor same it case do year we. Full how way even the sigh. Extremely nor furniture fat questions now provision incommode preserved. Our side fail find like now. Discovered travelling for insensible partiality unpleasing impossible she. Sudden up my excuse to suffer ladies though or. Bachelor possible marianne directly confined relation as on he.</p>","empty"];$(function(){"use strict";$(function(){var a=33,b=Backbone.Model.extend({defaults:function(){return{sender:"",senderMail:"",subject:"",body:dummyBodies[Math.round(3*Math.random())],receiver:"",timestamp:new Date((new Date).getTime()-72e5).getTime(),read:!0,starred:!1,attachment:!1,folderId:1,selected:!1}},markRead:function(){this.save({read:!0})},toggleStarred:function(){this.save({starred:!this.get("starred")})},toggleSelected:function(){this.save({selected:!this.get("selected")})}}),c=Backbone.Model.extend({defaults:{name:"",current:!1,order:100},sync:function(){}}),d=Backbone.Collection.extend({model:c,url:"js/folders.json",comparator:"order",parse:function(b){return b.push({name:"Starred",id:a,order:4}),b}}),e=new d,f=Backbone.View.extend({tagName:"li",template:_.template($("#folder-template").html()),events:{click:"selectFolder"},initialize:function(){this.listenTo(this.model,"change",this.render)},render:function(){return this.$el.attr("class",this.model.get("current")?"active":""),this.$el.html(this.template(this.model.toJSON())),this},selectFolder:function(){var a=this;e.each(function(b){b.save({current:b==a.model})}),o.showEmailsView()}}),g=Backbone.Collection.extend({model:b,url:"js/emails.json",comparator:function(a){return-a.get("timestamp")},search:function(a,b){if(""==a)return this.where({folderId:b});var c=new RegExp(a,"gi");return this.filter(function(a){return a.get("folderId")==b&&c.test(a.get("subject"))||c.test(a.get("sender"))})}}),h=new g,i=Backbone.View.extend({tagName:"tr",template:_.template($("#mail-item-template").html()),events:{"click .selected-checkbox":"toggleSelected","ifToggled .selected-checkbox":"toggleSelected","click .starred":"toggleStarred","click .name,.subject":"openEmail"},initialize:function(){this.listenTo(this.model,"change",this.render)},render:function(){return this.$el.attr("class",this.model.get("read")?"":"unread"),this.$el.html(this.template(this.model.toJSON())),this.$el.find("input[type='checkbox']").iCheck({checkboxClass:"icheckbox_square-grey",radioClass:"iradio_square-grey"}),this},formatDate:function(a){var b=new Date(a),c=new Date,d=new Date(c.getFullYear(),c.getMonth(),c.getDate());return b.getTime()>d?b.getHours()+":"+(b.getMinutes()<10?"0"+b.getMinutes():b.getMinutes()):["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][b.getMonth()]+" "+b.getDate()},toggleSelected:function(){this.model.toggleSelected()},toggleStarred:function(){this.model.toggleStarred()},openEmail:function(){this.model.save({read:!0}),o.setCurrentView(new j({model:this.model}))}}),j=Backbone.View.extend({template:_.template($("#email-view-template").html()),attributes:{id:"email-view","class":"email-view"},events:{"click #email-opened-reply":"replyEmail"},initialize:function(){this.listenTo(this.model,"change",this.render)},render:function(){return this.$el.html(this.template(this.model.toJSON())),this},formatDate:function(a){var b=new Date(a),c=new Date,d=new Date(c.getFullYear(),c.getMonth(),c.getDate());if(b.getTime()>d)return b.getHours()+":"+(b.getMinutes()<10?"0"+b.getMinutes():b.getMinutes());var e=Math.floor((c.getTime()-b.getTime())/864e5);return["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][b.getMonth()]+" "+b.getDate()+" ("+e+" days ago)"},replyEmail:function(){var a="<br/><br/><br/><blockquote>"+this.model.get("body")+"</blockquote> <br/>",c=new b({body:a,receiver:this.model.get(this.model.get("sender")?"sender":"senderMail"),subject:"Re: "+this.model.get("subject")});o.showComposeView(c)}}),k=Backbone.View.extend({template:_.template($("#compose-view-template").html()),attributes:{id:"compose-view","class":"compose-view"},events:{"click #compose-save-button, #compose-send-button, #compose-discard-button":"backToFolders"},render:function(){return this.$el.html(this.template(this.model.toJSON())),this._initViewComponents(),this},backToFolders:function(){o.showEmailsView()},_initViewComponents:function(){var a={"font-styles":function(a){return"<li class='dropdown'><a class='btn btn-sm btn-transparent dropdown-toggle' data-toggle='dropdown' href='#'><i class='fa fa-font'></i>&nbsp;<span class='current-font'>"+a.font_styles.normal+"</span>&nbsp;&nbsp;<i class='fa fa-caret-down'></i></a><ul class='dropdown-menu'><li><a data-wysihtml5-command='formatBlock' data-wysihtml5-command-value='div'>"+a.font_styles.normal+"</a></li><li><a data-wysihtml5-command='formatBlock' data-wysihtml5-command-value='p'>"+a.font_styles.normal+"</a></li><li><a data-wysihtml5-command='formatInline' data-wysihtml5-command-value='span'>"+a.font_styles.normal+"</a></li><li><a data-wysihtml5-command='formatBlock' data-wysihtml5-command-value='h1'>"+a.font_styles.h1+"</a></li><li><a data-wysihtml5-command='formatBlock' data-wysihtml5-command-value='h2'>"+a.font_styles.h2+"</a></li><li><a data-wysihtml5-command='formatBlock' data-wysihtml5-command-value='h3'>"+a.font_styles.h3+"</a></li></ul></li>"},emphasis:function(){return"<li><div class='btn-group'><a class='btn btn-sm btn-transparent ' data-wysihtml5-command='bold' title='CTRL+B'><i class='fa fa-bold'></i></a><a class='btn btn-sm btn-transparent ' data-wysihtml5-command='italic' title='CTRL+I'><i class='fa fa-italic'></i></a></div></li>"},lists:function(a){return"<li><div class='btn-group'><a class='btn btn-sm btn-transparent ' data-wysihtml5-command='insertUnorderedList' title='"+a.lists.unordered+"'><i class='fa fa-list'></i></a><a class='btn btn-sm btn-transparent ' data-wysihtml5-command='insertOrderedList' title='"+a.lists.ordered+"'><i class='fa fa-th-list'></i></a><a class='btn btn-sm btn-transparent ' data-wysihtml5-command='Outdent' title='"+a.lists.outdent+"'><i class='fa fa-outdent'></i></a><a class='btn btn-sm btn-transparent ' data-wysihtml5-command='Indent' title='"+a.lists.indent+"'><i class='fa fa-indent'></i></a></div></li>"},link:function(a){return"<li><div class='bootstrap-wysihtml5-insert-link-modal modal hide fade'><div class='modal-header'><a class='close' data-dismiss='modal'>×</a><h3>"+a.link.insert+"</h3></div><div class='modal-body'><input value='http://' class='bootstrap-wysihtml5-insert-link-url input-xlarge'></div><div class='modal-footer'><a href='#' class='btn' data-dismiss='modal'>"+a.link.cancel+"</a><a href='#' class='btn btn-primary' data-dismiss='modal'>"+a.link.insert+"</a></div></div><a class='btn btn-sm btn-transparent ' data-wysihtml5-command='createLink' title='"+a.link.insert+"'><i class='fa fa-share'></i></a></li>"},image:function(a){return"<li><div class='bootstrap-wysihtml5-insert-image-modal modal hide fade'><div class='modal-header'><a class='close' data-dismiss='modal'>×</a><h3>"+a.image.insert+"</h3></div><div class='modal-body'><input value='http://' class='bootstrap-wysihtml5-insert-image-url input-xlarge'></div><div class='modal-footer'><a href='#' class='btn' data-dismiss='modal'>"+a.image.cancel+"</a><a href='#' class='btn btn-primary' data-dismiss='modal'>"+a.image.insert+"</a></div></div><a class='btn btn-sm btn-transparent ' data-wysihtml5-command='insertImage' title='"+a.image.insert+"'><i class='fa fa-picture-o'></i></a></li>"},html:function(a){return"<li><div class='btn-group'><a class='btn btn-sm btn-transparent ' data-wysihtml5-action='change_view' title='"+a.html.edit+"'><i class='fa fa-pencil'></i></a></div></li>"}};this.$("#email-body").wysihtml5({html:!0,customTemplates:a,stylesheets:["css/application.min.css"],parserRules:wysihtml5ParserRules,events:{load:function(){$(this.composer.doc.head).prepend("<style>body{background: none !important;}</style>")}}}),this.$("#email-compose").fileupload({url:"server/php/",autoUpload:!0})}}),l=Backbone.View.extend({tagName:"table",attributes:{id:"folder-view","class":"folder-view table table-striped"},template:_.template($("#folders-view-template").html()),folderActionsTemplate:_.template($("#folder-actions-template").html()),events:{"click #toggle-all":"toggleAll","ifToggled #toggle-all":"toggleAll","click #select-all":"selectAll","click #select-none":"selectNone","click #select-read":"selectRead","click #select-unread":"selectUnread","click #mark-as-read":"markSelectedAsRead","click #mark-as-unread":"markSelectedAsUnread","click #delete":"deleteEmails"},initialize:function(){this.currentFolderEmails=new g,this.folders=e,this.listenTo(this.currentFolderEmails,"reset",this.renderEmails),this.listenTo(this.currentFolderEmails,"all",this.renderFolderActions),this.listenTo(this.currentFolderEmails,"destroy",this.renderEmails),this.listenTo(this.folders,"change",this.resetEmails)},render:function(){return this.resetEmails(),this.delegateEvents(this.events),this},renderFolderActions:function(){var a=this.currentFolderEmails.where({selected:!0}).length,b=a==this.currentFolderEmails.length,c=a>0;this.$("#folder-actions").html(this.folderActionsTemplate({allSelected:b,anySelected:c})),this.$toggleAllCheckbox=this.$("#toggle-all"),this.$el.find("#toggle-all").iCheck({checkboxClass:"icheckbox_square-grey",radioClass:"iradio_square-grey"})},addOne:function(a){var b=new i({model:a});this.$el.find("tbody").append(b.render().el)},renderEmails:function(){this.reset(),this.currentFolderEmails.each(this.addOne,this);var a=this.folders.where({current:!0})[0],b=this.currentFolderEmails.where({read:!1}).length,c="Inbox";a&&(c=a.get("name")),$("#folder-title").html(c+" <small>("+b+" unread messages)</small>")},reset:function(){this.$el.html(this.template())},resetEmails:function(){var b=this.folders.where({current:!0})[0],c=1;b&&(c=b.get("id")),this.currentFolderEmails.reset(c==a?h.where({starred:!0}):h.where({folderId:c}))},toggleAll:function(){var a=this.$toggleAllCheckbox.prop("checked");this.currentFolderEmails.each(function(b){b.save({selected:a})})},selectAll:function(){this.$toggleAllCheckbox.prop("checked",!0),this.toggleAll()},selectNone:function(){this.$toggleAllCheckbox.prop("checked",!1),this.toggleAll()},selectRead:function(){this.selectNone(),_(this.currentFolderEmails.where({read:!0})).each(function(a){a.save({selected:!0})})},selectUnread:function(){this.selectNone(),_(this.currentFolderEmails.where({read:!1})).each(function(a){a.save({selected:!0})})},search:function(){var a=this.folders.where({current:!0})[0],b=1;a&&(b=a.get("id")),this.currentFolderEmails.reset(h.search($("#mailbox-search").val(),b))},markSelectedAsRead:function(){_(this.currentFolderEmails.where({selected:!0})).each(function(a){a.save({read:!0})})},markSelectedAsUnread:function(){_(this.currentFolderEmails.where({selected:!0})).each(function(a){a.save({read:!1})})},deleteEmails:function(){_(this.currentFolderEmails.where({selected:!0})).each(function(a){a.destroy()})}}),m=new l,n=Backbone.View.extend({el:$("#mailbox-app"),$content:$("#mailbox-content"),events:{"keyup #mailbox-search":"search","click #compose-btn":"handleComposeBtnClick"},initialize:function(){this.currentView=m,this.folders=e,this.listenTo(this.folders,"reset",this.renderFolders);var a=this;this.folders.fetch({success:function(){h.fetch({success:function(){a.render()}})}})},render:function(){this.$content.html(this.currentView.render().el)},setCurrentView:function(a){this.currentView=a,this.render()},renderFolders:function(){this.resetFoldersList(),this.folders.each(this.addFolder,this)},resetFoldersList:function(){this.$("#folders-list").html("")},addFolder:function(a){var b=new f({model:a});this.$("#folders-list").append(b.render().el)},search:function(){"function"==typeof this.currentView.search&&this.currentView.search()},showEmailsView:function(){this.currentView!=m&&this.setCurrentView(m)},handleComposeBtnClick:function(){this.showComposeView()},showComposeView:function(a){a=a?a:new b({body:""}),this.setCurrentView(new k({model:a}))}}),o=new n})});